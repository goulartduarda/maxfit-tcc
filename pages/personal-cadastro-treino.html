<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MaxFit — Personal (Criar Treino)</title>

  <!-- Bootstrap e Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    :root {
      --mf-primary: #FF6A00;
      --mf-bg: #0f0f10;
      --mf-card: #17181a;
      --mf-border: #2a2b2e;
    }

    body {
      background: linear-gradient(180deg, var(--mf-bg), #121317 60%);
      color: #e9ecef;
      font-family: 'Inter', sans-serif;
    }

    .mf-navbar {
      background: #0e0f10d6;
      border-bottom: 1px solid var(--mf-border);
      backdrop-filter: blur(6px);
    }

    .mf-card {
      background: var(--mf-card);
      border: 1px solid var(--mf-border);
      border-radius: 1rem;
      padding: 2rem;
    }

    .mf-label {
      font-size: .9rem;
      color: #cfd3d8;
    }

    .mf-input {
      background: #141518;
      border: 1px solid var(--mf-border);
      color: #e9ecef;
    }

    .exercise-row {
      background: #141518;
      border: 1px dashed #2e3034;
      border-radius: 1rem;
    }
  </style>
</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-dark mf-navbar sticky-top">
    <div class="container py-2">
      <span class="fw-bold text-light"><i class="fa-solid fa-dumbbell text-warning me-2"></i> MaxFit — Personal</span>
      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-sm btn-outline-light" href="personal-home.html"><i class="fa-solid fa-house"></i></a>
        <a class="btn btn-sm btn-outline-light" href="personal-alunos.html">Alunos</a>
        <a class="btn btn-sm btn-light" href="personal-cadastro-treino.html">Criar Treino</a>
      </div>
    </div>
  </nav>

  <!-- CONTEÚDO PRINCIPAL -->
  <main class="container py-5">
    <div class="mf-card">
      <h2 class="h5 mb-4">Criar Treino</h2>

      <div id="alerta" class="alert alert-warning d-none"></div>

      <!-- FORMULÁRIO PRINCIPAL -->
      <div class="row g-3">
        <div class="col-md-6">
          <label class="mf-label">Aluno</label>
          <select id="aluno" class="form-select mf-input"></select>
        </div>
        <div class="col-md-3">
          <label class="mf-label">Objetivo</label>
          <select id="objetivo" class="form-select mf-input">
            <option>Definição</option>
            <option>Emagrecimento</option>
            <option>Hipertrofia</option>
            <option>Performance</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="mf-label">Nível</label>
          <select id="nivel" class="form-select mf-input">
            <option>Iniciante</option>
            <option>Intermediário</option>
            <option>Avançado</option>
          </select>
        </div>
        <div class="col-md-9">
          <label class="mf-label">Título do treino</label>
          <input id="titulo" class="form-control mf-input" placeholder="Ex: Treino A — Peito e tríceps">
        </div>
        <div class="col-md-3">
          <label class="mf-label">Validade</label>
          <input type="date" id="validade" class="form-control mf-input">
        </div>
      </div>

      <!-- EXERCÍCIOS -->
      <div class="mt-4">
        <h5 class="mb-3">Exercícios</h5>
        <div id="exercicios" class="vstack gap-3"></div>
        <button id="btnAddExercicio" class="btn btn-sm btn-outline-light mt-2">
          <i class="fa-solid fa-plus me-1"></i>Adicionar exercício
        </button>
      </div>

      <!-- BOTÃO SALVAR -->
      <div class="mt-4">
        <button id="btnSalvar" class="btn btn-success">
          <i class="fa-solid fa-floppy-disk me-2"></i>Salvar treino
        </button>
      </div>
    </div>
  </main>

  <!-- SCRIPTS -->
  <script>
    const API = "http://localhost:3000";

    document.addEventListener("DOMContentLoaded", async () => {
      const alunoSelect = document.getElementById("aluno");
      const exerciciosDiv = document.getElementById("exercicios");
      const btnAddExercicio = document.getElementById("btnAddExercicio");
      const btnSalvar = document.getElementById("btnSalvar");
      const alerta = document.getElementById("alerta");

      // Verifica login do personal
      let personal = null;
      try {
        personal = JSON.parse(localStorage.getItem("usuario_logado"));
      } catch (e) {
        personal = null;
      }

      if (!personal || personal.tipo !== "personal") {
        alert("Sessão expirada. Faça login novamente como personal.");
        window.location.href = "06-entrar.html";
        return;
      }

      // Carrega alunos vinculados ao personal
      try {
        const res = await fetch(`${API}/api/alunos-do-personal/${personal.id}`);
        const alunos = await res.json();

        alunoSelect.innerHTML = "<option value=''>Selecione um aluno</option>";

        if (alunos.length === 0) {
          alunoSelect.innerHTML = "<option value=''>Nenhum aluno vinculado ainda</option>";
        } else {
          alunos.forEach(a => {
            alunoSelect.innerHTML += `<option value="${a.id}">${a.nome} — ${a.email}</option>`;
          });
        }
      } catch (e) {
        alerta.textContent = "Erro ao carregar alunos.";
        alerta.classList.remove("d-none");
      }

      // Adicionar exercício
      btnAddExercicio.addEventListener("click", () => {
        const div = document.createElement("div");
        div.className = "p-3 exercise-row";
        div.innerHTML = `
          <div class="row g-2 align-items-end">
            <div class="col-md-4"><label class="mf-label">Exercício</label><input class="form-control mf-input ex-nome" placeholder="Ex: Supino reto"></div>
            <div class="col-md-2"><label class="mf-label">Séries</label><input type="number" class="form-control mf-input ex-series"></div>
            <div class="col-md-2"><label class="mf-label">Reps</label><input class="form-control mf-input ex-reps"></div>
            <div class="col-md-2"><label class="mf-label">Descanso (s)</label><input type="number" class="form-control mf-input ex-descanso"></div>
            <div class="col-md-2"><button class="btn btn-outline-danger btn-del">Excluir</button></div>
          </div>`;
        div.querySelector(".btn-del").addEventListener("click", () => div.remove());
        exerciciosDiv.appendChild(div);
      });

      // Salvar treino
      btnSalvar.addEventListener("click", async () => {
        const aluno_id = alunoSelect.value;
        const objetivo = document.getElementById("objetivo").value;
        const nivel = document.getElementById("nivel").value;
        const titulo = document.getElementById("titulo").value.trim();
        const validade = document.getElementById("validade").value;

        if (!aluno_id || !titulo) {
          alerta.textContent = "⚠️ Selecione um aluno e defina um título para o treino.";
          alerta.classList.remove("d-none");
          return;
        }

        const exercicios = Array.from(exerciciosDiv.children).map(div => ({
          nome: div.querySelector(".ex-nome").value.trim(),
          series: div.querySelector(".ex-series").value,
          repeticoes: div.querySelector(".ex-reps").value,
          descanso: div.querySelector(".ex-descanso").value
        })).filter(ex => ex.nome !== "");

        if (exercicios.length === 0) {
          alerta.textContent = "⚠️ Adicione ao menos um exercício.";
          alerta.classList.remove("d-none");
          return;
        }

        const payload = {
          aluno_id,
          personal_id: personal.id,
          titulo,
          objetivo,
          nivel,
          validade,
          exercicios
        };

        try {
          const res = await fetch(`${API}/api/treinos`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const data = await res.json();
          if (data.sucesso) {
            alert("✅ Treino salvo com sucesso!");
            window.location.href = "personal-alunos.html";
          } else {
            alerta.textContent = "Erro ao salvar treino.";
            alerta.classList.remove("d-none");
          }
        } catch (e) {
          alerta.textContent = "Erro na conexão com o servidor.";
          alerta.classList.remove("d-none");
        }
      });
    });
  </script>
</body>
</html>
